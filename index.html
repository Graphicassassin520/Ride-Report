<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- Mobile responsiveness -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Enhanced Ride-Along Report App</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Custom Styles -->
  <style>
    .hidden { display: none; }
    .container-custom { max-width: 800px; }
  </style>
  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#">Ride-Along Report</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ml-auto" id="navItems">
        <!-- Nav items are inserted dynamically after login -->
      </ul>
    </div>
  </nav>

  <!-- LOGIN SECTION -->
  <div class="container container-custom my-4" id="loginDiv">
    <div class="card">
      <div class="card-header">
        <h3 class="mb-0">Login</h3>
      </div>
      <div class="card-body">
        <form id="loginForm">
          <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" class="form-control" required placeholder="Enter your email">
          </div>
          <div class="form-group">
            <label for="password">Password:</label>
            <input type="password" id="password" class="form-control" required placeholder="Enter your password">
          </div>
          <div class="form-group">
            <label for="role">Role:</label>
            <!-- Only Super Admin, Sales Manager, and Trainer are allowed -->
            <select id="role" class="form-control" required>
              <option value="">Select Role</option>
              <option value="SuperAdmin">Super Admin</option>
              <option value="SalesManager">Sales Manager</option>
              <option value="Trainer">Trainer</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary btn-block">Login</button>
        </form>
      </div>
    </div>
  </div>

  <!-- MAIN APP SECTION (Report Form) -->
  <div class="container container-custom my-4 hidden" id="appDiv">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Ride-Along Report Form</h3>
      <div>
        <button id="dashboardBtn" class="btn btn-info btn-sm hidden">Dashboard</button>
        <button id="userMgmtBtn" class="btn btn-secondary btn-sm hidden">Manage Users</button>
        <button id="logoutBtn" class="btn btn-danger btn-sm">Logout</button>
      </div>
    </div>
    <div class="card">
      <div class="card-body">
        <form id="reportForm">
          <!-- Hidden field to store report ID for editing -->
          <input type="hidden" id="reportId" value="">
          <!-- New Field: Sales Rep Evaluated -->
          <div class="form-group">
            <label for="evaluatedSalesRep">Sales Rep Evaluated:</label>
            <input type="text" id="evaluatedSalesRep" name="Sales Rep Evaluated" class="form-control" required placeholder="Enter Sales Rep Name">
          </div>
          <!-- Intent Section -->
          <div class="mb-3">
            <h5>Intent</h5>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="intent_understandable">Understandable?</label>
                <select id="intent_understandable" name="Intent: Understandable?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="intent_clear">Clear (yes or no) Today?</label>
                <select id="intent_clear" name="Intent: Clear (yes or no) Today?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="intent_1stDayBenefits">Mention of 1st Day Benefits?</label>
                <select id="intent_1stDayBenefits" name="Intent: Mention of 1st Day Benefits?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="intent_getAgreement">Get Agreement?</label>
                <select id="intent_getAgreement" name="Intent: Get Agreement?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-6">
                <label for="intent_effective">Effective?</label>
                <select id="intent_effective" name="Intent: Effective?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>
          </div>
          <!-- Discovery Section -->
          <div class="mb-3">
            <h5>Discovery</h5>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="discovery_buildTrust">Did Rep build trust?</label>
                <select id="discovery_buildTrust" name="Discovery: Did Rep build trust?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="discovery_expansionQuestions">Ask expansion questions?</label>
                <select id="discovery_expansionQuestions" name="Discovery: Ask expansion questions?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="discovery_needsDetermined">Were needs determined?</label>
                <select id="discovery_needsDetermined" name="Discovery: Were needs determined?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="discovery_discoverProblem">Discover a problem?</label>
                <select id="discovery_discoverProblem" name="Discovery: Discover a problem?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="discovery_personalizeClose">Personalize close?</label>
                <select id="discovery_personalizeClose" name="Discovery: Personalize close?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="discovery_gainCommitment">Gain commitment?</label>
                <select id="discovery_gainCommitment" name="Discovery: Gain commitment?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label for="discovery_trialCloseEffective">Was a trial close effective?</label>
              <select id="discovery_trialCloseEffective" name="Discovery: Was a trial close effective?" class="form-control" required>
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
          </div>
          <!-- Commitment to Vacation Section -->
          <div class="mb-3">
            <h5>Commitment to Vacation</h5>
            <div class="form-group">
              <label for="vacation_importance">Why are Vacations important?</label>
              <input type="text" id="vacation_importance" name="Commitment to Vacation: Why are Vacations important?" class="form-control" required>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="vacation_dbmUncovered">Was the DBM uncovered?</label>
                <select id="vacation_dbmUncovered" name="Commitment to Vacation: Was the DBM uncovered?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-6">
                <label for="vacation_commitmentTravel">Was Commitment to Travel established?</label>
                <select id="vacation_commitmentTravel" name="Commitment to Vacation: Was Commitment to Travel established?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>
          </div>
          <!-- Hotel Inflation Section -->
          <div class="mb-3">
            <h5>Hotel Inflation</h5>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="hotel_moneyAgreement">Money agreement over 30 vacations?</label>
                <select id="hotel_moneyAgreement" name="Hotel Inflation: Money agreement over 30 vacations?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="hotel_moneyCommitment">Money commitment with inflation?</label>
                <select id="hotel_moneyCommitment" name="Hotel Inflation: Money commitment with inflation?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="hotel_effectiveDelivery">Effective delivery/Get agreement?</label>
                <select id="hotel_effectiveDelivery" name="Hotel Inflation: Effective delivery/Get agreement?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>
          </div>
          <!-- Rent VS. Own Section -->
          <div class="mb-3">
            <h5>Rent VS. Own</h5>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="rentAgreeSpend">Agreement to spend $ anyway?</label>
                <select id="rentAgreeSpend" name="Rent VS. Own: Agreement to spend $ anyway?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="rent_disadvantagesHotels">Did the Rep cover disadvantages of hotels?</label>
                <select id="rent_disadvantagesHotels" name="Rent VS. Own: Did the Rep cover disadvantages of hotels?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="rent_advantagesVillas">Did the Rep cover the advantages of villas?</label>
                <select id="rent_advantagesVillas" name="Rent VS. Own: Did the Rep cover the advantages of villas?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label for="rent_guestSpendNotOwn">Guest agreement on how much they would spend not to own?</label>
              <input type="text" id="rent_guestSpendNotOwn" name="Rent VS. Own: Guest agreement on how much they would spend not to own?" class="form-control" required>
            </div>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="rent_guestInitialSpend">Did the guest initial the amount they would spend anyway?</label>
                <select id="rent_guestInitialSpend" name="Rent VS. Own: Did the guest initial the amount they would spend anyway?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="rent_effectiveDelivery">Effective delivery?</label>
                <select id="rent_effectiveDelivery" name="Rent VS. Own: Effective delivery?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="rent_trialClose">Rent VS. Own trial close?</label>
                <select id="rent_trialClose" name="Rent VS. Own: Rent VS. Own trial close?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label for="rent_gainCommitment">Gain Commitment?</label>
              <select id="rent_gainCommitment" name="Rent VS. Own: Gain Commitment?" class="form-control" required>
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
          </div>
          <!-- Ownership Advantages Section -->
          <div class="mb-3">
            <h5>Ownership Advantages</h5>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="ownership_coverAdvantages">Did the Rep effectively cover advantages?</label>
                <select id="ownership_coverAdvantages" name="Ownership Advantages: Did the Rep effectively cover advantages?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="ownership_explainDeeded">Did the Rep explain how it’s deeded?</label>
                <select id="ownership_explainDeeded" name="Ownership Advantages: Did the Rep explain how it’s deeded?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="ownership_encourageQuestions">Did the Rep encourage guests to speak/ask questions?</label>
                <select id="ownership_encourageQuestions" name="Ownership Advantages: Did the Rep encourage guests to speak/ask questions?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>
          </div>
          <!-- Presentation Begins Section -->
          <div class="mb-3">
            <h5>Presentation Begins – Spinnaker Profile Booklet</h5>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="presentation_spinnakerIntroduced">Was Spinnaker Introduced?</label>
                <select id="presentation_spinnakerIntroduced" name="Presentation: Was Spinnaker Introduced?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="presentation_bransonOwnership">Was ownership in Branson discussed?</label>
                <select id="presentation_bransonOwnership" name="Presentation: Was ownership in Branson discussed?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="presentation_guestInPicture">Did the Rep put guest in the picture?</label>
                <select id="presentation_guestInPicture" name="Presentation: Did the Rep put guest in the picture?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="presentation_resortsUsed">Did the Rep find which resorts the guest would use?</label>
                <select id="presentation_resortsUsed" name="Presentation: Did the Rep find which resorts the guest would use?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-6">
                <label for="presentation_buildExcitement">Did the Rep build excitement?</label>
                <select id="presentation_buildExcitement" name="Presentation: Did the Rep build excitement?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label for="presentation_expandAmenities">Did the Rep expand on resort amenities?</label>
              <select id="presentation_expandAmenities" name="Presentation: Did the Rep expand on resort amenities?" class="form-control" required>
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
          </div>
          <!-- Spinnaker Advantages Section -->
          <div class="mb-3">
            <h5>Spinnaker Advantages</h5>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="spinnaker_threeReasons">Did the Rep cover 3 reasons why they would get involved today?</label>
                <select id="spinnaker_threeReasons" name="Spinnaker Advantages: Did the Rep cover 3 reasons why they would get involved today?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="spinnaker_threeImportant">Did the Rep write down the 3 most important things in their lives?</label>
                <select id="spinnaker_threeImportant" name="Spinnaker Advantages: Did the Rep write down the 3 most important things in their lives?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="spinnaker_trialClose">Did the Rep ask trial close, "Is there anything that would get in the way of you becoming our newest Spinnaker owners today?"</label>
                <select id="spinnaker_trialClose" name="Spinnaker Advantages: Did the Rep ask trial close?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>
          </div>
          <!-- Property Tour Section -->
          <div class="mb-3">
            <h5>Property Tour</h5>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="property_involvement">Involvement from guest?</label>
                <select id="property_involvement" name="Property Tour: Involvement from guest?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="property_bonusTime">Put the guest in the picture for Bonus Time usage?</label>
                <select id="property_bonusTime" name="Property Tour: Put the guest in the picture for Bonus Time usage?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="property_personalize">Personalize features and benefits?</label>
                <select id="property_personalize" name="Property Tour: Personalize features and benefits?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>
          </div>
          <!-- Maintenance Fees and Taxes Section -->
          <div class="mb-3">
            <h5>Maintenance Fees and Taxes</h5>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="maintenance_sellFees">Sell Fees?</label>
                <select id="maintenance_sellFees" name="Maintenance Fees and Taxes: Sell Fees?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="maintenance_referralProgram">Referral Program?</label>
                <select id="maintenance_referralProgram" name="Maintenance Fees and Taxes: Referral Program?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="maintenance_getAgreement">Get agreement/effective delivery?</label>
                <select id="maintenance_getAgreement" name="Maintenance Fees and Taxes: Get agreement/effective delivery?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>
          </div>
          <!-- Model Close Section -->
          <div class="mb-3">
            <h5>Model Close</h5>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="model_otherThanMoney">Anything other than the money close on property?</label>
                <select id="model_otherThanMoney" name="Model Close: Anything other than the money close on property?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-md-6">
                <label for="model_getCommitment">Get commitment?</label>
                <select id="model_getCommitment" name="Model Close: Get commitment?" class="form-control" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>
          </div>
          <!-- Return to Preview Center (Informational) -->
          <div class="mb-3">
            <h5>Return to Preview Center</h5>
            <p>This section is informational.</p>
          </div>
          <!-- Signatures & Comments Section -->
          <div class="mb-3">
            <h5>Signatures & Comments</h5>
            <div class="form-group">
              <label for="managerSignature">Managers/Trainers Signature:</label>
              <input type="text" id="managerSignature" name="Managers/Trainers Signature" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="managerSignatureDate">Date (Managers/Trainers):</label>
              <input type="date" id="managerSignatureDate" name="Managers/Trainers Date" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="repSignature">Representatives Signature:</label>
              <input type="text" id="repSignature" name="Representatives Signature" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="repSignatureDate">Date (Representatives):</label>
              <input type="date" id="repSignatureDate" name="Representatives Date" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="comments">Comments:</label>
              <textarea id="comments" name="Comments" class="form-control" rows="3"></textarea>
            </div>
          </div>
          <button type="submit" class="btn btn-success btn-block" id="submitReportBtn">Submit Report</button>
        </form>
      </div>
    </div>
  </div>

  <!-- DASHBOARD SECTION (For Managers/Trainers) -->
  <div class="container container-custom my-4 hidden" id="dashboardDiv">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Reports Dashboard</h3>
      <div>
        <button id="backToFormBtn" class="btn btn-secondary btn-sm">Back to Form</button>
        <button id="exportCSVBtn" class="btn btn-success btn-sm">Export CSV</button>
      </div>
    </div>
    <div class="card mb-3">
      <div class="card-body">
        <form id="filterForm" class="form-inline">
          <div class="form-group mb-2 mr-2">
            <label for="filterEmail" class="mr-2">Rep Email:</label>
            <input type="text" id="filterEmail" class="form-control" placeholder="Type rep email">
          </div>
          <div class="form-group mb-2 mr-2">
            <label for="filterDate" class="mr-2">Date:</label>
            <input type="date" id="filterDate" class="form-control">
          </div>
          <button type="button" id="applyFiltersBtn" class="btn btn-primary mb-2 mr-2">Apply Filters</button>
          <button type="button" id="clearFiltersBtn" class="btn btn-outline-secondary mb-2">Clear Filters</button>
        </form>
      </div>
    </div>
    <div class="card">
      <div class="card-body">
        <table class="table table-bordered table-striped" id="reportsTable">
          <thead class="thead-dark">
            <tr>
              <th>ID</th>
              <th>Submitted By</th>
              <th>Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Report rows inserted dynamically -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- USER MANAGEMENT SECTION (For Super Admin) -->
  <div class="container container-custom my-4 hidden" id="userManagementDiv">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>User Management</h3>
      <div>
        <button id="backToFormFromUserMgmtBtn" class="btn btn-secondary btn-sm">Back to Form</button>
      </div>
    </div>
    <!-- Add User Form -->
    <div class="card mb-3">
      <div class="card-header">Add New User</div>
      <div class="card-body">
        <form id="addUserForm" class="form-inline">
          <div class="form-group mb-2 mr-2">
            <label for="newUserEmail" class="mr-2">Email:</label>
            <input type="email" id="newUserEmail" class="form-control" required placeholder="Enter user email">
          </div>
          <div class="form-group mb-2 mr-2">
            <label for="newUserRole" class="mr-2">Role:</label>
            <select id="newUserRole" class="form-control" required>
              <option value="">Select Role</option>
              <!-- Only allow Super Admin, Sales Manager, and Trainer -->
              <option value="SuperAdmin">Super Admin</option>
              <option value="SalesManager">Sales Manager</option>
              <option value="Trainer">Trainer</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary mb-2">Add User</button>
        </form>
      </div>
    </div>
    <!-- Users Table -->
    <div class="card">
      <div class="card-body">
        <table class="table table-bordered table-striped" id="usersTable">
          <thead class="thead-dark">
            <tr>
              <th>ID</th>
              <th>Email</th>
              <th>Role</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- User rows inserted dynamically -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- DELETE CONFIRMATION MODAL (for both reports and users) -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="confirmDeleteLabel">Confirm Deletion</h5>
          <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" id="confirmDeleteBody">
          Are you sure you want to delete this item?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" id="deleteConfirmBtn" class="btn btn-danger">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- EDIT USER MODAL (for Super Admin) -->
  <div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title" id="editUserLabel">Edit User</h5>
          <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="editUserForm">
            <input type="hidden" id="editUserId" value="">
            <div class="form-group">
              <label for="editUserEmail">Email:</label>
              <input type="email" id="editUserEmail" class="form-control" disabled>
            </div>
            <div class="form-group">
              <label for="editUserRole">Role:</label>
              <select id="editUserRole" class="form-control" required>
                <option value="">Select Role</option>
                <!-- Only allow Super Admin, Sales Manager, and Trainer -->
                <option value="SuperAdmin">Super Admin</option>
                <option value="SalesManager">Sales Manager</option>
                <option value="Trainer">Trainer</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- TOAST NOTIFICATION -->
  <div aria-live="polite" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; min-width: 250px;">
    <div id="toastNotification" class="toast" data-delay="3000">
      <div class="toast-header">
        <strong class="mr-auto" id="toastTitle">Notification</strong>
        <small>Now</small>
        <button type="button" class="ml-2 mb-1 close" data-dismiss="toast">
          <span>&times;</span>
        </button>
      </div>
      <div class="toast-body" id="toastBody"></div>
    </div>
  </div>

  <!-- jQuery, Popper, Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script>
    /********** GLOBAL VARIABLES **********/
    let autoSaveInterval;
    let editingReport = false;
    let reportToDelete = null;
    let userToDelete = null;
    const REPORTS_KEY = 'reports';
    const USERS_KEY = 'users';

    /********** USER MANAGEMENT UTILITIES **********/
    function getUsers() {
      return JSON.parse(localStorage.getItem(USERS_KEY)) || [];
    }
    function saveUsers(users) {
      localStorage.setItem(USERS_KEY, JSON.stringify(users));
    }
    function generateUserId() {
      return 'USR-' + new Date().getTime();
    }

    /********** REPORT UTILITIES **********/
    function getReports() {
      return JSON.parse(localStorage.getItem(REPORTS_KEY)) || [];
    }
    function saveReports(reports) {
      localStorage.setItem(REPORTS_KEY, JSON.stringify(reports));
    }
    function generateReportId() {
      return 'RPT-' + new Date().getTime();
    }

    /********** UI HELPER: SHOW/HIDE CONTAINERS **********/
    function showContainer(id) {
      ['loginDiv', 'appDiv', 'dashboardDiv', 'userManagementDiv'].forEach(divId => {
        document.getElementById(divId).classList.add('hidden');
      });
      document.getElementById(id).classList.remove('hidden');
    }

    /********** TOAST NOTIFICATIONS **********/
    function showToast(title, message) {
      document.getElementById('toastTitle').innerText = title;
      document.getElementById('toastBody').innerText = message;
      $('#toastNotification').toast('show');
    }

    /********** UPDATE NAVBAR **********/
    function updateNavbar() {
      const role = sessionStorage.getItem('userRole');
      let navHTML = '';
      if (role) {
        navHTML += `<li class="nav-item"><span class="nav-link">Logged in as: ${sessionStorage.getItem('userEmail')} (${role})</span></li>`;
        // If super admin, add Manage Users nav item
        if (role === 'SuperAdmin') {
          navHTML += `<li class="nav-item"><button id="navUserMgmtBtn" class="btn btn-sm btn-secondary">Manage Users</button></li>`;
        }
        navHTML += `<li class="nav-item"><button id="navbarLogoutBtn" class="btn btn-sm btn-danger ml-2">Logout</button></li>`;
      }
      document.getElementById('navItems').innerHTML = navHTML;
      if(document.getElementById('navbarLogoutBtn')) {
        document.getElementById('navbarLogoutBtn').addEventListener('click', () => {
          sessionStorage.clear();
          clearInterval(autoSaveInterval);
          showContainer('loginDiv');
        });
      }
      if(document.getElementById('navUserMgmtBtn')) {
        document.getElementById('navUserMgmtBtn').addEventListener('click', () => {
          clearInterval(autoSaveInterval);
          populateUserManagement();
          showContainer('userManagementDiv');
        });
      }
    }

    /********** LOGIN PROCESS **********/
    document.getElementById('loginForm').addEventListener('submit', function(event) {
      event.preventDefault();
      const email = document.getElementById('email').value;
      const role = document.getElementById('role').value;
      sessionStorage.setItem('userEmail', email);
      sessionStorage.setItem('userRole', role);
      updateNavbar();
      // Automatically add user to the users list if not exists
      let users = getUsers();
      const existingUser = users.find(u => u.email.toLowerCase() === email.toLowerCase());
      if (!existingUser) {
        const newUser = { id: generateUserId(), email: email, role: role };
        users.push(newUser);
        saveUsers(users);
      }
      // Show Dashboard button for Managers/Trainers
      if (role === 'SalesManager' || role === 'Trainer') {
        document.getElementById('dashboardBtn').classList.remove('hidden');
      } else {
        document.getElementById('dashboardBtn').classList.add('hidden');
      }
      // Show Manage Users only for SuperAdmin
      if (role === 'SuperAdmin') {
        document.getElementById('userMgmtBtn').classList.remove('hidden');
      } else {
        document.getElementById('userMgmtBtn').classList.add('hidden');
      }
      showContainer('appDiv');
      startAutoSave();
      showToast('Login Successful', 'Welcome to the Ride-Along Report App!');
    });

    /********** LOGOUT PROCESS **********/
    document.getElementById('logoutBtn').addEventListener('click', function() {
      sessionStorage.clear();
      clearInterval(autoSaveInterval);
      showContainer('loginDiv');
      showToast('Logout', 'You have been logged out.');
    });

    /********** NAVIGATION BUTTONS **********/
    document.getElementById('dashboardBtn').addEventListener('click', function() {
      clearInterval(autoSaveInterval);
      populateDashboard();
      showContainer('dashboardDiv');
    });
    document.getElementById('userMgmtBtn').addEventListener('click', function() {
      clearInterval(autoSaveInterval);
      populateUserManagement();
      showContainer('userManagementDiv');
    });
    document.getElementById('backToFormBtn').addEventListener('click', function() {
      showContainer('appDiv');
      startAutoSave();
    });
    document.getElementById('backToFormFromUserMgmtBtn').addEventListener('click', function() {
      showContainer('appDiv');
      startAutoSave();
    });

    /********** AUTO-SAVE REPORT DRAFT **********/
    function startAutoSave() {
      autoSaveInterval = setInterval(() => {
        const formData = new FormData(document.getElementById('reportForm'));
        const draft = {};
        formData.forEach((value, key) => { draft[key] = value; });
        localStorage.setItem('draftReport', JSON.stringify(draft));
      }, 5000);
    }
    window.addEventListener('load', () => {
      const draft = localStorage.getItem('draftReport');
      if (draft) {
        const draftData = JSON.parse(draft);
        for (const key in draftData) {
          if (draftData.hasOwnProperty(key)) {
            const el = document.querySelector(`[name="${key}"]`);
            if (el) { el.value = draftData[key]; }
          }
        }
      }
    });

    /********** REPORT FORM SUBMISSION **********/
    document.getElementById('reportForm').addEventListener('submit', function(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      let reportData = {};
      formData.forEach((value, key) => { reportData[key] = value; });
      const currentUser = sessionStorage.getItem('userEmail');
      reportData.submittedBy = currentUser;
      reportData.submissionDate = new Date().toISOString();
      reportData.status = "Pending Review";
      
      let reports = getReports();
      if (editingReport) {
        const id = document.getElementById('reportId').value;
        reportData.id = id;
        reports = reports.map(rep => rep.id === id ? reportData : rep);
        editingReport = false;
      } else {
        reportData.id = generateReportId();
        reports.push(reportData);
      }
      saveReports(reports);
      localStorage.removeItem('draftReport');
      generatePDF(reportData);
      showToast('Report Submitted', 'Your report has been submitted successfully!');
      form.reset();
      document.getElementById('reportId').value = '';
    });

    /********** PDF GENERATION **********/
    async function generatePDF(reportData) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let yPos = 10;
      doc.setFontSize(16);
      doc.text("Ride-Along Report", 10, yPos);
      yPos += 10;
      doc.setFontSize(12);
      for (const key in reportData) {
        if (reportData.hasOwnProperty(key) &&
            !['id', 'submittedBy', 'submissionDate', 'status'].includes(key)) {
          let text = key + ": " + reportData[key];
          if (yPos > 280) {
            doc.addPage();
            yPos = 10;
          }
          doc.text(text, 10, yPos);
          yPos += 7;
        }
      }
      doc.setFontSize(10);
      doc.text("Report ID: " + reportData.id, 10, yPos + 5);
      doc.text("Submitted by: " + reportData.submittedBy, 10, yPos + 12);
      doc.text("Submission Date: " + new Date(reportData.submissionDate).toLocaleString(), 10, yPos + 19);
      doc.text("Status: " + reportData.status, 10, yPos + 26);
      doc.save("RideAlong_Report_" + reportData.id + ".pdf");
    }

    /********** DASHBOARD POPULATION (Reports) **********/
    function populateDashboard() {
      const tbody = document.querySelector('#reportsTable tbody');
      tbody.innerHTML = '';
      const reports = getReports();
      reports.forEach(report => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${report.id}</td>
          <td>${report.submittedBy}</td>
          <td>${new Date(report.submissionDate).toLocaleDateString()}</td>
          <td>${report.status}</td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="editReport('${report.id}')">Edit</button>
            <button class="btn btn-sm btn-warning" onclick="markReviewed('${report.id}')">Mark as Reviewed</button>
            <button class="btn btn-sm btn-danger" onclick="confirmDelete('${report.id}', 'report')">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    /********** EDIT/DELETE REPORT FUNCTIONS **********/
    window.editReport = function(reportId) {
      const reports = getReports();
      const report = reports.find(rep => rep.id === reportId);
      if (report) {
        for (const key in report) {
          if (report.hasOwnProperty(key)) {
            const el = document.querySelector(`[name="${key}"]`);
            if (el) { el.value = report[key]; }
          }
        }
        document.getElementById('reportId').value = report.id;
        editingReport = true;
        showContainer('appDiv');
        clearInterval(autoSaveInterval);
        startAutoSave();
      }
    };

    window.markReviewed = function(reportId) {
      let reports = getReports();
      reports = reports.map(rep => {
        if (rep.id === reportId) { rep.status = "Reviewed"; }
        return rep;
      });
      saveReports(reports);
      populateDashboard();
      showToast('Status Updated', 'Report marked as reviewed.');
    };

    /********** DELETE CONFIRMATION (Reports & Users) **********/
    // Call this function with type = "report" or "user"
    window.confirmDelete = function(id, type) {
      if (type === "report") {
        reportToDelete = id;
        document.getElementById('confirmDeleteBody').innerText = "Are you sure you want to delete this report?";
      } else if (type === "user") {
        userToDelete = id;
        document.getElementById('confirmDeleteBody').innerText = "Are you sure you want to delete this user?";
      }
      $('#confirmDeleteModal').modal('show');
    };

    document.getElementById('deleteConfirmBtn').addEventListener('click', function() {
      if (reportToDelete) {
        let reports = getReports();
        reports = reports.filter(rep => rep.id !== reportToDelete);
        saveReports(reports);
        populateDashboard();
        showToast('Report Deleted', 'The report has been deleted.');
        reportToDelete = null;
      } else if (userToDelete) {
        let users = getUsers();
        users = users.filter(user => user.id !== userToDelete);
        saveUsers(users);
        populateUserManagement();
        showToast('User Deleted', 'The user has been deleted.');
        userToDelete = null;
      }
      $('#confirmDeleteModal').modal('hide');
    });

    /********** USER MANAGEMENT FUNCTIONS (Super Admin) **********/
    function populateUserManagement() {
      const tbody = document.querySelector('#usersTable tbody');
      tbody.innerHTML = '';
      const users = getUsers();
      users.forEach(user => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${user.id}</td>
          <td>${user.email}</td>
          <td>${user.role}</td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="editUser('${user.id}')">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="confirmDelete('${user.id}', 'user')">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.getElementById('addUserForm').addEventListener('submit', function(event) {
      event.preventDefault();
      const email = document.getElementById('newUserEmail').value;
      const role = document.getElementById('newUserRole').value;
      let users = getUsers();
      // Check if user already exists (by email)
      if (users.find(u => u.email.toLowerCase() === email.toLowerCase())) {
        showToast('Error', 'A user with that email already exists.');
        return;
      }
      const newUser = { id: generateUserId(), email: email, role: role };
      users.push(newUser);
      saveUsers(users);
      populateUserManagement();
      document.getElementById('addUserForm').reset();
      showToast('User Added', 'New user has been added.');
    });

    window.editUser = function(userId) {
      const users = getUsers();
      const user = users.find(u => u.id === userId);
      if (user) {
        document.getElementById('editUserId').value = user.id;
        document.getElementById('editUserEmail').value = user.email;
        document.getElementById('editUserRole').value = user.role;
        $('#editUserModal').modal('show');
      }
    };

    document.getElementById('editUserForm').addEventListener('submit', function(event) {
      event.preventDefault();
      const id = document.getElementById('editUserId').value;
      const role = document.getElementById('editUserRole').value;
      let users = getUsers();
      users = users.map(u => {
        if (u.id === id) { u.role = role; }
        return u;
      });
      saveUsers(users);
      populateUserManagement();
      $('#editUserModal').modal('hide');
      showToast('User Updated', 'User role has been updated.');
    });

    /********** DASHBOARD FILTERING **********/
    document.getElementById('applyFiltersBtn').addEventListener('click', function() {
      const emailFilter = document.getElementById('filterEmail').value.trim().toLowerCase();
      const dateFilter = document.getElementById('filterDate').value;
      const tbody = document.querySelector('#reportsTable tbody');
      tbody.innerHTML = '';
      let reports = getReports();
      if (emailFilter) {
        reports = reports.filter(report => report.submittedBy.toLowerCase().includes(emailFilter));
      }
      if (dateFilter) {
        reports = reports.filter(report => {
          const reportDate = new Date(report.submissionDate).toISOString().split("T")[0];
          return reportDate === dateFilter;
        });
      }
      reports.forEach(report => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${report.id}</td>
          <td>${report.submittedBy}</td>
          <td>${new Date(report.submissionDate).toLocaleDateString()}</td>
          <td>${report.status}</td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="editReport('${report.id}')">Edit</button>
            <button class="btn btn-sm btn-warning" onclick="markReviewed('${report.id}')">Mark as Reviewed</button>
            <button class="btn btn-sm btn-danger" onclick="confirmDelete('${report.id}', 'report')">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    });
    
    document.getElementById('clearFiltersBtn').addEventListener('click', function() {
      document.getElementById('filterEmail').value = "";
      document.getElementById('filterDate').value = "";
      populateDashboard();
    });
  </script>
</body>
</html>